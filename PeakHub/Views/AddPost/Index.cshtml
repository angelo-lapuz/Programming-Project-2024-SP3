@model PeakHub.ViewModels.Forum.AddPostViewModel
@{ ViewData["Title"] = "Add Post"; }

<link rel="stylesheet" href="~/css/_forum.css" asp-append-version="true" />

<div id="addContent">
    <div class="header">
        <img src="@Model.User.ProfileImg" alt="Your Profile Image" />
        <p> <strong>@Model.User.Username</strong> </p>
    </div>

    <form class="content" id="createPost">
        @Html.AntiForgeryToken()
        <input type="hidden" id="boardID" value="@Model.BoardID" />

        <!-- Post content input -->
        <textarea id="addPostContent" name="postContent" placeholder="What's on your mind?"></textarea>

        <!-- Media upload input -->
        <input type="file" id="addPostMedia" name="mediaFile" style="display: none" accept="image/*" />
        <div id="mediaView" style="display: none"></div>

        <div id="progressContainer" style="display: none;">
            <p>Uploading, please wait...</p>
            <progress id="progressBar" value="0" max="100"></progress>
        </div>

        <!-- Error Message Display -->
        <p id="errorMsg" style="display: none"></p>

        <!-- Action Buttons -->
        <div class="row-btn">
            <button type="button" class="btn-secondary" id="addMediaFile">Add File</button>
            <button type="button" class="btn-secondary deactivate" id="removeMediaFile">Remove File</button>
        </div>

        <div class="row-btn">
            <button type="submit" id="addPostSubmit" class="btn-secondary deactivate">Submit</button>
            <button type="button" id="cancelPost" class="btn-secondary">Cancel</button>
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Cancel Add Post
    $("#cancelPost").on("click", function () { 
        window.location.href = `/Forum/Index?boardID=${@Model.BoardID}`;
    });

    // Toggle 'Submit' Button on and off
    function toggleSubmitBtn() {
        var content = $("#addPostContent").val().trim();
        var media = $("#addPostMedia")[0].files.length > 0;
        var btn = $("#addPostSubmit");

        btn.toggleClass("deactivate", content === '' && !media);
    }

    // Generate File Preview
    function filePreview(file) {
        const reader = new FileReader();

        reader.onload = function (e) {
            $("#mediaView").html(`<img src="${e.target.result}" alt="Image Preview" />`).show();
        }

        reader.readAsDataURL(file);
    }

    // Toggle 'Submit' on content
    $("#addPostContent").on("keyup", toggleSubmitBtn);

    // Preview File then Toggle 'Submit' on content
    $("#addPostMedia").on("change", function () {
        const file = $(this)[0].files[0];

        if (file) {
            filePreview(file);
            $("#addMediaFile").addClass("deactivate");
            $("#removeMediaFile").removeClass("deactivate");
        }

        toggleSubmitBtn();
    });

    // Allows User to select file [img for now [TEMP]]
    $("#addMediaFile").on("click", function () { $("#addPostMedia").click(); });

    // Removes selected file 
    $("#removeMediaFile").on("click", function () {
        $("#addPostMedia").val('');
        $("#mediaView").hide().empty();

        $("#removeMediaFile").addClass("deactivate");
        $("#addMediaFile").removeClass("deactivate");

        toggleSubmitBtn();
    });

    // -------------------------------------------------------------------------------- //

    // Upload File to S3 
    function uploadFile(key, url, file, callback) {
        const xhr = new XMLHttpRequest();

        xhr.open("PUT", url, true);
        xhr.setRequestHeader("Content-Type", file.type);

        $("#progressContainer").show();

        xhr.upload.onprogress = function (e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                $("#progressBar").val(percentComplete);
            }
        }

        xhr.onload = function() {
            if (xhr.status == 200) {
                callback(`https://peakhub-post-content.s3.amazonaws.com/${key}`);
            } else {
                callback(null);
            }
        }

        xhr.onerror = function () { alert("An Error Occured"); }
        xhr.send(file);
    }

    // Submit to DB
    function submitPost(boardID, content, media = "NULL", mediaType = "NULL") {
        console.log(`Board = ${boardID}`);
        console.log(`Content = ${content}`);
        console.log(`Media = ${media}`);
        console.log(`MediaType = ${mediaType}`);

        $.ajax({
            url: "AddPost/CreatePost",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ 
                BoardID: boardID, 
                Content: content, 
                Media: media, 
                MediaType: mediaType 
            }),
            success: function(response) {
                if (response.success) {
                    window.location.href = `/Forum/Index?boardID=${response.boardID}`;
                } else {
                    $("#errorMsg").show().text(response.message);
                }
            },
            error: function (xhr) {
                // Set Error
                if (xhr.status === 400 && xhr.responseJSON && xhr.responseJSON.error) {
                    $("#errorMsg").text(xhr.responseJSON.error).show();
                } else {
                    console.log(`Error: [${xhr.status}] - ${xhr.statusText}`);
                }

                // Enable Buttons
                if (Media != null) {
                    $("#removeMediaFile").removeClass("deactivate");
                } else {
                    $("#addMediaFile").removeClass("deactivate");
                }

                $("#cancelPost").removeClass("deactivate");
                toggleSubmitBtn();
            }
        });
    }

    // Handle Form Submit
    $("#createPost").on("submit", function (e) { 
        e.preventDefault();

        $("#errorMsg").text('').hide();
        $("button").addClass("deactivate");

        const boardID = $("#boardID").val();
        const file = $("#addPostMedia")[0].files[0];
        const content = $("#addPostContent").val().trim();
        const sanitizedContent = (content === null || content === '') ? "NULL" : content;

        if (file) {
            const fileType = file.type || "application/octet-stream";

            $.ajax({
                url: "/AddPost/GetPresignedURL",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ BoardID: boardID, FileType: fileType }),
                success: function (response) {
                    if (response.success) {
                        uploadFile(response.key, response.url, file, function (url) {
                            if (url) {
                                console.log(`Upload Complete: [${url}]`);
                                submitPost(boardID, sanitizedContent, url, response.type);
                            }
                            else { console.log("Upload Error!"); }
                        });
                    }
                    else {
                        console.log(`Signed URL Error: [${response.message}]`);
                    }
                },
                error: function (response) {
                    console.log(`Get URL Error: [${response.message}]`);
                }
            });
        }
        else { submitPost(boardID, sanitizedContent); }
    });
</script>